DROP TABLE DODATKI_EXTRA;
CREATE TABLE DODATKI_EXTRA (
    ID_DODATKU NUMBER(2) GENERATED BY DEFAULT ON NULL AS IDENTITY CONSTRAINT dod_pk_id PRIMARY KEY ,
    PSEUDO VARCHAR2(15) CONSTRAINT dod_fg_pseudo REFERENCES KOCURY(PSEUDO),
    DODATEK_EXTRA NUMBER(3) NOT NULL
);

CREATE OR REPLACE TRIGGER kontr_wirus
    BEFORE UPDATE OF PRZYDZIAL_MYSZY ON KOCURY
    FOR EACH ROW
    DECLARE
       -- PRAGMA AUTONOMOUS_TRANSACTION;
    BEGIN
        IF ORA_LOGIN_USER <> 'TYGRYS' AND :NEW.PRZYDZIAL_MYSZY > :OLD.PRZYDZIAL_MYSZY AND :NEW.FUNKCJA = 'MILUSIA' THEN
            EXECUTE IMMEDIATE '
            DECLARE
                CURSOR koty_milus IS SELECT PSEUDO FROM KOCURY WHERE FUNKCJA = ''MILUSIA'';
            BEGIN
                FOR kot IN koty_milus
                LOOP
                    INSERT INTO DODATKI_EXTRA (PSEUDO, DODATEK_EXTRA) VALUES (kot.PSEUDO, -10);
                END LOOP;
            END;';
           -- COMMIT;
        END IF;
    END;

 UPDATE KOCURY
  SET PRZYDZIAL_MYSZY = PRZYDZIAL_MYSZY+1
    WHERE FUNKCJA='MILUSIA';
SELECT * FROM DODATKI_EXTRA;
ROLLBACK ;
DROP TRIGGER kontr_wirus;
DROP TABLE DODATKI_EXTRA;